## This code generates nonlinear OpenSees responses, trains a neural-network surrogate, and propagates uncertainty via Monte Carlo simulation.
It then fits bounded MLE fragility curves for multiple damage states and produces clean, marker-free probability-of-exceedance plots.##

Code:

# CODE 1: OPENSEES - FIXED WITH BOUNDED MLE FITTING 
# FIX from previous Code: DS4 Complete now uses bounded MLE + Clean plot without data point markers


import numpy as np
import matplotlib.pyplot as plt
import pandas as pd
import torch
import torch.nn as nn
import torch.optim as optim
from scipy.stats import norm
from scipy.optimize import minimize
import openseespy.opensees as ops
import tempfile
import uuid
import os
import warnings
warnings.filterwarnings('ignore')

device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
np.random.seed(42)
torch.manual_seed(42)

print("\n" + "="*100)
print("OPENSEES FRAGILITY ANALYSIS - FIXED (BOUNDED MLE + CLEAN PLOT)")
print("="*100)

# ============================================================================
# GROUND MOTION DATA
# ============================================================================

AG = np.array([

-0.0110, -0.0103, -0.00897, -0.00969, -0.0122, -0.0145, -0.0131, -0.0112, -0.00867, -0.00867, -0.0134, -0.0179, -0.0198, -0.0165, -0.0147, -0.0110, -0.00836, -0.00428, -0.00673, -0.0134, -0.0194, -0.0200, -0.00673, 0.00306, 0.0144, -0.00500, -0.0131, -0.0147, -0.0207, -0.0265, -0.0331, -0.0312, -0.0175, -0.0201, -0.0166, -0.0167, -0.00683, 0.00255, 0.0153, 0.0241, 0.0257, 0.0343, 0.0472, 0.0502, 0.0427, 0.0366, 0.0276, 0.0240, 0.0346, 0.0420, 0.0540, 0.0652, 0.0746, 0.0665, 0.0611, 0.0408, 0.0408, 0.00642, -0.0525, -0.0803, -0.0615, -0.0494, -0.0255, -0.00602, 0.0137, 0.0314, 0.0509, 0.0724, 0.101, 0.124, 0.156, 0.148, 0.118, 0.0953, 0.0910, 0.0944, 0.0856, 0.0919, 0.101, 0.123, 0.0334, -0.151, -0.211, -0.203, -0.207, -0.186, -0.176, -0.178, -0.178, -0.185, -0.166, -0.138, -0.111, -0.0797, -0.0437, -0.00173, 0.0367, 0.0800, 0.118, 0.163, 0.200, 0.246, 0.278, 0.310, 0.326, 0.349, 0.288, 0.237, -0.122, -0.242, -0.167, -0.191, -0.112, -0.0768, -0.0176, 0.0115, 0.0544, 0.0913, 0.121, 0.179, 0.0587, -0.268, -0.158, -0.176, -0.103, -0.0590, 0.0242, -0.0683, -0.202, -0.167, -0.172, -0.151, -0.125, -0.102, -0.0766, -0.0533, -0.0276, -0.00449, 0.0192, -0.00969, -0.0442, -0.0855, -0.0970, -0.0730, -0.0611, -0.0341, -0.0110, 0.0189, 0.0428, 0.0686, -0.00989, -0.0379, -0.00408, 0.00112, 0.0351, 0.0576, 0.0900, 0.115, 0.139, 0.0223, 0.0246, 0.0696, 0.0703, 0.135, 0.138, 0.208, -0.0949, -0.134, -0.0706, -0.0557, 0.00734, 0.0688, -0.109, -0.152, -0.109, -0.118, -0.0777, -0.0570, -0.0219, -0.0128, -0.0687, -0.0330, -0.0344, -0.0111, 0.00173, 0.0305, 0.0498, 0.0620, 0.0226, -0.00326, -0.0250, 0.00785, 0.0215, 0.0579, 0.0842, 0.123, 0.151, 0.177, 0.0429, 0.00296, 0.0264, 0.0299, -0.00561, -0.0150, 0.0146, 0.0210, 0.0509, 0.0658, 0.0976, 0.115, 0.148, 0.166, 0.199, 0.190, 0.202, 0.180, 0.127, -0.123, -0.0553, -0.0392, -0.0317, -0.114, -0.169, -0.251, -0.207, -0.188, -0.135, -0.0979, -0.0331, 0.0157, 0.0832, 0.135, 0.186, -0.00591, -0.0172, 0.0291, 0.0456, 0.100, 0.145, 0.189, 0.251, 0.172, -0.141, -0.102, -0.111, -0.0925, -0.0478, -0.127, -0.215, -0.165, -0.172, -0.134, -0.113, -0.0788, -0.0520, -0.0555, -0.122, -0.123, -0.118, -0.117, -0.0731, -0.0557, 0.00653, -0.0820, -0.166, -0.0876, -0.0980, -0.0404, -0.0150, 0.0325, 0.0661, 0.0893, 0.0481, 0.0202, -0.00275, 0.0298, 0.0454, 0.0800, 0.105, 0.138, 0.164, 0.190, 0.131, 0.0653, 0.0208, 0.0320, 0.0380, 0.0506, 0.0240, -0.00857, -0.0171, -0.0115, -0.0234, -0.0253, -0.0160, -0.00704, 0.0150, 0.0386, 0.0590, 0.0260, -0.00418, -0.0436, -0.0136, 0.00969, 0.0235, -0.0132, -0.00510, 0.00816, 0.0214, 0.0387, 0.0520, 0.0160, -0.00326, -0.0113, 0.000510, 0.00775, 0.00357, -0.00969, -0.00367, -0.00163, 0.00387, 0.00867, -0.00571, -0.0310, -0.0429, -0.0249, -0.0241, -0.0180, -0.0132, -0.00184, 0.0207, -0.0110, -0.00928, -0.00347, -0.0108, -0.0113, -0.0101, -0.000204, 0.00744, 0.0240, 0.0362, 0.0719, 0.0794, 0.0188, -0.0268, -0.0126, -0.00428, 0.0162, 0.00489, -0.0223, -0.0476, -0.0436, -0.0220, -0.00438, 0.0162, 0.0326, 0.0427, 0.0125, -0.0163, -0.0208, -0.00836, -0.0210, -0.0140, -0.00561, 0.00540, 0.0137, 0.0271, 0.0237, 0.00806, -0.000816, 0.0204, 0.0444, 0.0502, 0.0195, 0.00938, -0.00224, -0.00214, 0.00530, 0.00948, 0.0260, 0.0375, 0.0535, 0.0552, 0.0433, 0.0406, 0.0570, 0.0771, 0.0372, 0.0419, 0.00999, -0.0208, -0.0254, -0.0413, -0.0421, -0.0480, -0.0442, -0.0467, -0.00581, 0.0182, -0.0212, -0.0502, -0.0540, -0.0369, -0.0413, -0.0314, -0.0322, -0.0270, -0.0270, -0.0274, -0.0352, -0.0315, -0.0221, -0.00795, 0.00887, 0.0287, 0.0316, 0.0365, 0.0348, 0.0365, 0.0293, 0.0311, 0.0114, 0.0218, 0.0139, 0.0392, -0.0878, -0.138, -0.137, -0.138, -0.121, -0.106, -0.0845, -0.0664, -0.0453, -0.0263, -0.00612, -0.00928, -0.0186, -0.0150, 0.00867, 0.0166, 0.00510, 0.0269, 0.0593, 0.0884, 0.122, 0.173, 0.113, -0.112, -0.0373, -0.0454, -0.0241, -0.0979, -0.0669, -0.0609, -0.0683, -0.0563, -0.00275, 0.0385, 0.109, 0.170, 0.0966, 0.0416, 0.0680, 0.0135, -0.00969, -0.0530, -0.0843, -0.117, -0.117, -0.0819, -0.0376, 0.00296, 0.0556, 0.120, 0.164, -0.0275, 0.00347, -0.00571, 0.00204, 0.0149, 0.0548, 0.0814, -0.0209, -0.0602, -0.0172, -0.0178, -0.00286, 0.00755, 0.0390, 0.0578, 0.0768, 0.0817, 0.0604, 0.0310, 0.00235, 0.00653, -0.0414, -0.0460, -0.00806, 0.0171, 0.0578, 0.00948, -0.00561, 0.00449, -0.0125, -0.0288, -0.0446, -0.0359, -0.0260, -0.0113, 0.0209, 0.0529, 0.0871, 0.116, 0.0747, 0.0242, -0.0375, -0.0276, -0.0221, -0.0890, -0.0992, -0.0601, -0.0343, 0.00785, 0.0264, 0.0518, 0.0368, 0.00826, -0.00571, -0.0213, -0.0323, -0.0243, -0.0383, -0.0561, -0.0736, -0.0819, -0.0533, -0.0347, -0.00112, 0.00663, -0.00377, -0.000510, -0.0171, -0.0418, -0.00816, 0.00806, 0.0381, 0.0627, 0.0678, 0.0259, -0.00581, -0.0483, -0.0363, -0.0248, -0.00489, 0.0128, 0.0386, 0.0246, -0.0231, -0.0436, -0.0692, -0.0674, -0.0602, -0.0523, -0.0416, -0.0315, -0.0271, -0.0552, -0.0640, -0.0926, -0.113, -0.0898, -0.0785, -0.0593, -0.0482, -0.0340, -0.0203, 0.00204, 0.0215, 0.0441, 0.0625, 0.0782, 0.0951, 0.109, 0.115, 0.121, 0.127, 0.136, 0.162, 0.184, 0.208, 0.126, 0.0451, -0.0143, -0.0679, -0.0566, -0.0707, -0.100, -0.127, -0.120, -0.107, -0.0938, -0.0758, -0.0825, -0.0867, -0.0877, -0.0880, -0.0890, -0.0885, -0.0902, -0.0548, 0.00530, 0.0219, 0.0250, 0.0591, 0.0320, 0.0241, 0.0495, 0.0601, 0.0535, 0.0362, 0.0201, 0.0203, 0.0502, 0.0350, 0.0294, 0.0441, 0.0244, 0.00897, 0.00785, -0.0151, -0.00785, -0.00194, 0.00765, 0.00449, -0.0148, -0.0322, -0.0246, -0.00286, 0.0186, 0.0434, 0.0448, 0.0522, 0.0475, 0.0488, 0.0197, 0.0226, 0.0279, 0.0401, 0.0514, 0.0588, 0.0600, 0.0838, 0.0813, 0.0968, 0.0352, 0.00459, -0.0125, -0.0354, -0.0434, -0.0424, -0.0280, -0.0275, 0.00755, 0.0436, -0.0236, -0.0395, -0.00846, 0.0142, 0.0454, 0.00275, -0.0711, -0.0812, -0.0256, -0.0138, 0.00806, -0.0117, -0.0256, -0.0340, -0.0274, -0.0307, -0.0204, -0.00683, -0.00387, 0.0107, 0.0302, 0.0351, 0.0976, 0.0916, 0.0183, -0.0369, -0.101, -0.0823, -0.0759, -0.0550, -0.0337, -0.0131, 0.00316, 0.0151, 0.0518, -0.00224, -0.0499, -0.0365, -0.0705, -0.0526, -0.0378, 0.00897, 0.0644, 0.0858, 0.131, 0.142, 0.121, 0.0766, 0.0229, -0.00897, -0.0231, 0.00755, 0.0185, 0.0555, 0.0407, 0.00459, -0.00836, -0.0189, -0.00204, 0.000612, -0.0119, -0.0214, -0.0309, -0.0522, -0.0741, -0.0590, -0.0271, -0.0182, 0.00408, 0.00999, 0.0140, 0.0225, 0.0446, 0.00928, -0.0559, -0.0566, -0.0248, -0.00826, 0.0255, 0.0418, 0.0186, -0.00275, -0.0248, -0.00153, 0.0252, 0.0491, 0.0798, 0.0634, 0.0338, -0.00143, -0.0199, -0.0252, -0.0216, -0.0112, 0.00510, 0.0246, -0.00347, -0.0220, -0.0480, -0.0370, -0.0199, -0.00184, 0.0173, -0.00816, 0.000510, 0.0235, 0.0381, 0.0613, 0.0526, 0.0441, 0.0351, 0.0515, 0.0666, 0.0696, 0.0175, -0.0173, -0.0537, -0.0677, -0.0395, -0.0226, -0.00337, 0.0121, -0.0131, -0.0358, -0.0524, -0.0342, -0.0222, -0.00122, 0.0145, 0.00714, -0.00642, -0.0122, -0.0328, -0.0353, -0.00928, 0.00744, 0.0315, 0.0481, 0.0615, 0.0587, 0.0337, -0.00744, -0.0792, -0.0620, -0.0447, -0.0213, 0.00316, 0.0357, 0.0299, 0.0123, 0.0345, 0.0323, 0.0259, 0.0210, 0.0202, 0.0177, 0.00214, -0.0147, -0.0350, -0.0346, -0.0148, -0.00286, 0.0173, -0.00979, -0.0260, -0.0284, -0.0396, -0.0247, -0.0219, -0.0186, -0.0177, -0.00387, -0.00275, -0.0189, -0.0125, 0.00887, 0.0350, 0.0709, 0.0928, 0.0870, 0.0775, 0.0523, 0.0190, 0.00153, -0.0194, -0.0154, -0.00744, 0.00214, 0.0132, 0.0219, 0.00245, -0.0126, -0.0335, -0.0529, -0.0722, -0.0590, -0.0471, -0.0313, -0.0148, -0.000918, -0.0184, -0.0324, -0.0474, -0.0399, -0.0352, -0.0322, -0.0444, -0.0501, -0.0484, -0.0428, -0.0368, -0.0282, -0.0263, -0.0142, -0.00693, 0.0517, 0.0736, 0.0895, 0.0797, 0.0780, 0.0448, 0.00816, 0.00133, -0.0128, -0.00153, 0.00306, 0.0106, 0.0106, 0.0197, 0.0209, 0.00755, -0.00571, -0.00734, 0.00714, 0.0108, 0.0150, -0.000918, -0.0162, -0.0191, -0.000714, 0.0158, 0.0107, -0.0117, -0.0308, -0.0315, -0.00969, -0.00591, 0.000408, 0.00204, 0.00510, 0.00581, 0.00989, 0.0137, 0.0180, 0.0222, 0.0266, 0.0308, 0.0353, 0.0394, 0.0483, 0.0401, 0.0243, 0.0117, -0.00806, -0.0126, 0.00551, 0.00275, -0.0255, -0.0577, -0.0642, -0.0603, -0.0421, -0.00693, 0.0277, 0.0282, -0.00214, -0.00612, -0.0112, -0.0225, -0.0424, -0.0529, -0.0226, 0.00306, 0.00806, 0.0142, 0.0174, 0.0258, 0.0329, 0.0399, 0.0167, -0.0139, -0.0329, -0.0297, -0.0293, -0.0310, -0.0346, -0.0250, -0.00775, 0.0127, 0.0383, 0.0410, 0.0250, 0.0159, -0.00408, -0.0156, -0.0295, -0.0322, -0.0113, 0.00959, 0.0342, 0.0587, 0.0432, 0.0146, -0.000714, -0.0138, -0.0275, -0.0348, -0.0364, -0.0404, -0.0410, -0.0498, -0.0489, -0.0414, -0.0415, -0.0358, -0.0191, -0.00581, 0.00449, -0.00194, -0.00734, -0.0172, -0.0117, 0.0128, 0.0365, 0.0667, 0.0730, 0.0777, 0.0754, 0.0640, 0.0494, 0.0269, -0.00449, -0.0294, -0.0392, -0.0502, -0.0436, -0.0424, -0.0281, -0.00530, 0.0242, 0.0434, 0.0616, 0.0461, 0.0290, 0.0128, -0.00551, -0.0280, -0.0431, -0.0178, 0.000102, 0.0259, 0.0490, 0.0654, 0.0565, 0.0421, 0.0188, -0.00489, -0.0309, -0.0541, -0.0722, -0.0946, -0.0880, -0.0643, -0.0383, 0.00887, 0.0315, 0.0601, 0.0626, 0.0393, 0.0358, 0.0317, 0.0251, 0.00194, -0.0202, -0.0161, -0.00153, 0.0101, 0.0292, 0.0416, 0.0574, 0.0541, 0.0320, 0.0168, -0.00245, -0.0193, -0.0281, -0.0378, -0.0459, -0.0545, -0.0493, -0.0386, -0.0302, -0.0200, -0.0188, -0.0162, -0.0121, -0.00540, 0.000204, 0.00602, -0.00235, -0.0114, -0.0209, -0.0328, -0.0396, -0.0348, -0.0293, -0.0334, -0.0415, -0.0497, -0.0574, -0.0657, -0.0566, -0.0455, -0.000816, 0.0258, 0.0419, 0.0657, 0.0590, 0.0483, 0.0392, 0.0393, 0.0347, 0.0364, 0.000816, -0.0259, -0.0469, -0.0480, -0.0226, -0.00663, 0.0167, 0.0362, 0.0514, 0.0378, 0.0286, 0.0161, 0.00418, -0.00275, 0.00214, 0.00449, 0.0101, 0.0138, 0.00959, 0.00591, 0.00224, -0.00316, -0.00316, 0.000408, -0.00255, -0.0126, -0.0240, -0.0414, -0.0540, -0.0715, -0.0329, -0.00530, 0.00959, 0.0334, 0.0487, 0.0519, 0.0365, 0.0349, 0.0312, 0.0291, 0.0268, 0.0171, -0.000510, -0.0216, -0.0372, -0.0316, -0.0303, -0.0286, -0.0242, -0.0271, -0.0314, -0.0373, -0.0364, -0.0314, -0.0197, 0.00194, 0.0200, 0.0163, 0.0132, 0.0143, 0.0112, 0.0110, 0.00938, 0.00908, 0.00194, -0.0134, -0.0252, -0.0445, -0.0441, -0.0306, -0.0196, -0.00489, 0.00989, 0.0171, 0.0151, 0.0176, 0.00795, -0.00591, -0.0219, -0.0239, 0.00612, 0.0267, 0.0274, 0.00857, -0.00418, -0.0231, -0.00775, 0.00316, 0.0186, 0.0316, 0.0488, 0.0468, 0.0169, -0.00591, -0.0404, -0.0453, -0.0246, -0.0103, 0.0221, 0.0266, 0.0123, 0.000816, -0.0171, -0.0390, -0.0577, -0.0796, -0.0631, -0.0261, 0.00449, 0.0465, 0.0798, 0.112, 0.0972, 0.0499, 0.0124, -0.0395, -0.0863, -0.125, -0.0881, -0.0628, -0.0232, 0.0153, 0.0486, 0.0329, 0.0253, 0.00969, 0.0231, 0.0345, 0.0515, 0.0606, 0.0529, 0.0563, 0.0607, 0.0629, 0.0605, 0.0475, 0.0161, -0.00785, -0.0235, -0.0309, -0.0335, -0.0371, -0.0500, -0.0673, -0.0737, -0.0799, -0.0863, -0.0577, -0.0213, 0.0131, 0.0389, 0.0498, 0.0370, 0.0255, 0.0161, 0.0384, 0.0606, 0.0642, 0.0377, 0.0221, 0.00408, 0.00235, -0.00632, -0.0292, -0.0387, -0.0466, -0.0515, -0.0792, -0.0640, -0.0193, 0.0193, 0.0519, 0.0759, 0.0764, 0.0573, 0.0464, 0.0535, 0.0648, 0.0745, 0.0868, 0.0945, 0.0994, 0.0947, 0.0830, 0.0269, -0.0295, -0.0919, -0.139, -0.0876, -0.0477, 0.00826, 0.0606, 0.0839, 0.0567, 0.0307, -0.00112, -0.0387, -0.0354, -0.00204, 0.0184, 0.0645, 0.103, 0.114, 0.113, 0.0959, 0.0821, 0.0620, 0.0518, 0.0210, -0.0205, -0.0583, -0.104, -0.136, -0.125, -0.123, -0.103, -0.0777, -0.0559, -0.0499, -0.0413, -0.0297, -0.0179, -0.0144, -0.00999, -0.00510, 0.00194, 0.00816, 0.00357, -0.00296, -0.00622, -0.00347, -0.00133, 0.00775, 0.0209, 0.0333, 0.0459, 0.0588, 0.0573, 0.0473, 0.0306, 0.0109, -0.000408, -0.00337, -0.00704, -0.0103, -0.0205, -0.0192, 0.00255, 0.0137, 0.0248, 0.0271, 0.0270, 0.0158, -0.00194, -0.00969, -0.0220, -0.0170, -0.0122, -0.00653, -0.0132, -0.0166, -0.0197, -0.0247, -0.0241, -0.0178, -0.0126, -0.0189, -0.0270, -0.0329, -0.0343, -0.0463, -0.0438, -0.0341, -0.0217, -0.00704, 0.00306, 0.000306, -0.00948, -0.00908, -0.0153, -0.0167, -0.0243, -0.0329, -0.0429, -0.0466, -0.0405, -0.0356, -0.0263, -0.0175, -0.00204, 0.0159, 0.0290, 0.0369, 0.0361, 0.0274, 0.0103, -0.00459, -0.0127, -0.0250, -0.0234, -0.0128, -0.00693, 0.00184, 0.00948, 0.0204, 0.0292, 0.0372, 0.0317, 0.0185, 0.00245, -0.0159, -0.0325, -0.0223, -0.0120, 0.00153, 0.0156, 0.0304, 0.0248, 0.0139, 0.0104, 0.00245, -0.00102, -0.00235, -0.00367, -0.00489, -0.00908, -0.0158, -0.0151, -0.00775, 0.0, -0.00204, -0.0151, -0.0229, -0.0381, -0.0372, -0.0256, -0.0167, -0.00143, 0.0156, 0.0308, 0.0401, 0.0414, 0.0393, 0.0335, 0.0187, 0.0127, 0.00714, -0.000102, -0.00693, -0.0133, -0.0131, -0.0117, -0.0104, -0.00857, -0.0144, -0.0209, -0.0274, -0.0357, -0.0366, -0.0303, -0.0231, 0.00184, 0.0101, 0.0207, 0.0261, 0.0203, 0.0163, 0.0109, 0.0159, 0.0202, 0.0247, 0.0144, 0.00561, -0.00673, -0.00989, -0.00265, 0.00163, 0.0102, 0.00959, 0.00398, 0.0, -0.00673, -0.0101, -0.0111, -0.0117, -0.0134, -0.0171, -0.0203, -0.0106, -0.00102, 0.00561, 0.0132, 0.0204, 0.0203, 0.0172, 0.0146, 0.0111, 0.0131, 0.0155, 0.0140, 0.0119, 0.00989, 0.00612, -0.00286, -0.00510, -0.00857, -0.0182, -0.0327, -0.0428, -0.0528, -0.0481, -0.0402, -0.0296, -0.0112, 0.00510, 0.0135, 0.0160, 0.0180, 0.0199, 0.0260, 0.0338, 0.0334, 0.0257, 0.0176, 0.00459, -0.00867, -0.0194, -0.0234, -0.0310, -0.0282, -0.0231, -0.0177, -0.0123, -0.0128, -0.0132, -0.00816, -0.00265, 0.00398, 0.00663, 0.00561, 0.00510, 0.00653, 0.0128, 0.0183, 0.0248, 0.0313, 0.0304, 0.0256, 0.0220, 0.0166, 0.0196, 0.0239, 0.0288, 0.0307, 0.0200, 0.0108, -0.00398, -0.0166, -0.0328, -0.0342, -0.0223, -0.0151, -0.00102, 0.00112, -0.00540, -0.0103, -0.0128, -0.0146, -0.0132, -0.0106, -0.00724, -0.00184, 0.00337, 0.00867, 0.0161, 0.0244, 0.0325, 0.0348, 0.0324, 0.0217, 0.00744, 0.000918, -0.00153, -0.00479, -0.00765, -0.0123, -0.0159, -0.0118, -0.00571, -0.000612, -0.000306, -0.000306, 0.00143, 0.00469, 0.00734, 0.00877, 0.00999, 0.0126, 0.0150, 0.0175, 0.0204, 0.0261, 0.0323, 0.0293, 0.0236, 0.0107, -0.000102, -0.00112, -0.00367, -0.00540, -0.00846, -0.00530, -0.000714, 0.00377, 0.00979, 0.0158, 0.0209, 0.0146, 0.00744, 0.00214, -0.00224, -0.00714, -0.0102, -0.00765, -0.00551, -0.00296, -0.00153, 0.0, -0.000102, -0.000612, -0.00112, -0.00102, -0.000306, 0.000102, 0.00163, 0.00540, 0.00877, 0.0128, 0.0157, 0.0134, 0.0104, 0.00571, 0.000612, -0.00408, -0.00999, -0.00979, -0.00469, -0.000714, 0.00316, 0.00459, 0.00693, 0.00530, 0.00459, 0.00184, -0.000204, -0.00296, -0.00286, -0.00173, -0.000612, -0.000510, -0.00173, -0.00224, -0.00367, -0.00326, -0.000714, 0.00143, 0.00418, 0.00663, 0.00642, 0.00530, 0.000612, -0.00459, -0.00775, -0.00653, -0.00663, -0.0109, -0.0164, -0.0177, -0.0119, -0.00714, -0.00367, -0.00255, -0.000204, 0.000408, 0.00367, 0.00836, 0.0117, 0.00714, 0.00387, -0.00102, -0.00255, -0.00347, -0.00418, -0.00459, -0.00663, -0.0122, -0.0119, -0.0110, -0.00999, -0.00826, -0.00775, -0.0112, -0.0141, -0.0169, -0.0147, -0.0133, -0.0113, -0.0110, -0.00999, -0.00999, -0.00642, -0.000204, 0.00551, 0.0112, 0.0155, 0.0201, 0.0173, 0.0143, 0.0105, 0.00653, 0.00102, -0.00683, -0.0107, -0.0124, -0.0141, -0.0169, -0.0219, -0.0274, -0.0279, -0.0221, -0.0182, -0.0118, -0.00622, 0.0, 0.00551, 0.0101, 0.0147, 0.0191, 0.0237, 0.0267, 0.0260, 0.0231, 0.0174, 0.0130, 0.00551, -0.00479, -0.0152, -0.0214, -0.0259, -0.0257, -0.0250, -0.0230, -0.0183, -0.0139, -0.00836, -0.00143, 0.00449, 0.00908, 0.00989, 0.0102, 0.0102, 0.0106, 0.0139, 0.0123, 0.0102, 0.00734, 0.00194, -0.00286, -0.00846, -0.0134, -0.0194, -0.0198, -0.0142, -0.0102, -0.00449, -0.00449, -0.00408, -0.00459, -0.00500, -0.00398, -0.00214, -0.00224, -0.00163, -0.00163, -0.00122, -0.00122, 0.00286, 0.00693, 0.0117, 0.00979, 0.00571, 0.00173, -0.00316, -0.00795, -0.00938, -0.00938, -0.00969, -0.00938, -0.00877, -0.00530, -0.00224, 0.00143, 0.00387, 0.00347, 0.00347, 0.00296, 0.00408, 0.00551, 0.00683, 0.00867, 0.00887, 0.00785, 0.00714, 0.00622, 0.00765, 0.00887, 0.0104, 0.0113, 0.00918, 0.00765, 0.00540, 0.00632, 0.00806, 0.00989, 0.0120, 0.0138, 0.0107, 0.00785, 0.00449, 0.00122, -0.00214, -0.00428, -0.00693, -0.00887, -0.0122, -0.0162, -0.0202, -0.0238, -0.0263, -0.0275, -0.0283, -0.0293, -0.0283, -0.0275, -0.0263, -0.0256, -0.0223, -0.0176, -0.0132, -0.0111, -0.0107, -0.00969, -0.00928, -0.00734, -0.00602, -0.00408, -0.00235, 0.00184, 0.00357, 0.00428, 0.00489, 0.00438, 0.00438, 0.00387, 0.00367, 0.00326, 0.00479, 0.00642, 0.00867, 0.0112, 0.0137, 0.0163, 0.0185, 0.0176, 0.0171, 0.0162, 0.0150, 0.0110, 0.00693, 0.00326, 0.000918, 0.00194, 0.00286, 0.00408, 0.00551, 0.00704, 0.00969, 0.0119, 0.0146, 0.0146, 0.0127, 0.0124, 0.0126, 0.0128, 0.0133, 0.0136, 0.0108, 0.00806, 0.00469, 0.00204, 0.000510, -0.00112, -0.00255, -0.00112, 0.00184, 0.00438, 0.00775, 0.0105, 0.0136, 0.0103, 0.00632, 0.00184, -0.00275, -0.00816, -0.00908, -0.00551, -0.00306, 0.000612, 0.00122, 0.00224, 0.00275, 0.00326, 0.00489, 0.00704, 0.00908, 0.0114, 0.0136, 0.0143, 0.0140, 0.0143, 0.0138, 0.0142, 0.0104, 0.00306, -0.00326, -0.00642, -0.00867, -0.0114, -0.0160, -0.0201, -0.0192, -0.0186, -0.0173, -0.0159, -0.0145, -0.0132, -0.0127, -0.0122, -0.0118, -0.0116, -0.0108, -0.00653, -0.00214, 0.000204, -0.000408, -0.000408, -0.00143, -0.00194, -0.000816, 0.00112, 0.00275, 0.00510, 0.00540, 0.00428, 0.00306, 0.00112, -0.000510, -0.00245, -0.00204, -0.000714, 0.000408, 0.00194, 0.00337, 0.00489, 0.00581, 0.00663, 0.00755, 0.00826, 0.00928, 0.0130, 0.0172, 0.0147, 0.0107, 0.00714, 0.00357, 0.000204, -0.00326, -0.00653, -0.00969, -0.00928, -0.00846, -0.00744, -0.00520, -0.00306, -0.000408, 0.00337, 0.00530, 0.00449, 0.00408, 0.00306, 0.00204, 0.00102, 0.000102, -0.00102, -0.00143, 0.000204, 0.00163, 0.00306, 0.00235, 0.00163, 0.00163, 0.00265, 0.00326, 0.00459, 0.00469, 0.00214, -0.000306, -0.00306, -0.00612, -0.00887, -0.0118, -0.0109, -0.00959, -0.00795, -0.00693, -0.00642, -0.00581, -0.00510, -0.00418, -0.00337, -0.00245, -0.00143, -0.000510, 0.000408, 0.00133, 0.00214, 0.000102, -0.00184, -0.00408, -0.00653, -0.00887, -0.0112, -0.0132, -0.0154, -0.0168, -0.0177, -0.0188, -0.0198, -0.0206, -0.0217, -0.0202, -0.0176, -0.0138, -0.00663, -0.00143, 0.00204, 0.00561, 0.00836, 0.00908, 0.0104, 0.00948, 0.00816, 0.00622, 0.00337, 0.000306, -0.00245, -0.00581, -0.00459, -0.00133, 0.00133, 0.00337, 0.00489, 0.00551, 0.00591, 0.00632, 0.00663, 0.00704, 0.00734, 0.00765, 0.00785, 0.00744, 0.00704, 0.00653, 0.00591, 0.00551, 0.00489, 0.00622, 0.00806, 0.00979, 0.0116, 0.0128, 0.0142, 0.0134, 0.0125, 0.0116, 0.0105, 0.00887, 0.00734, 0.00571, 0.00408, 0.00245, 0.000714, 0.000408, 0.000816, 0.000918, 0.00235, 0.00428, 0.00530, 0.00622, 0.00734, 0.00806, 0.00908, 0.00969, 0.00969, 0.00948, 0.00908, 0.00255, 0.0, -0.000510, -0.00204, -0.00245, -0.00337, -0.00489, -0.00653, -0.00816, -0.00989, -0.0116, -0.0131, -0.0108, -0.00908, -0.00673, -0.00438, -0.00194, -0.00112, -0.000918, -0.000510, -0.000408, 0.000510, 0.00143, 0.00245, 0.00357, 0.00438, 0.00449, 0.00398, 0.00133, -0.000816, -0.00367, -0.00479, -0.00561, -0.00632, -0.00693, -0.00744, -0.00816, -0.00765, -0.00653, -0.00286, 0.000510, 0.00469, 0.00663, 0.00612, 0.00612, 0.00551, 0.00500, 0.00449, 0.00398, 0.00296, 0.0, -0.00265, -0.00530, -0.00428, -0.00377, -0.00255, -0.00153, -0.000204, 0.000204, 0.0, -0.000102, -0.000408, -0.000714, -0.000612, -0.000102, 0.000306, 0.000714, -0.000102, -0.000714, -0.00153, -0.00245, -0.00296, -0.00286, -0.00286, -0.00255, -0.00245, -0.00214, -0.00275, -0.00449, -0.00591, -0.00775, -0.00857, -0.00836, -0.00846, -0.00765, -0.00510, -0.00286, -0.000204, 0.00184, 0.00184, 0.00214, 0.00214, 0.00214, 0.00316, 0.00438, 0.00500, 0.00500, 0.00500, 0.00489, 0.00479, 0.00530, 0.00683, 0.00806, 0.00969, 0.00989, 0.00979, 0.00979, 0.00948, 0.00928, 0.00908, 0.00887, 0.00857, 0.00836, 0.00816, 0.00785, 0.00632, 0.00479, 0.00357, 0.00367, 0.00347, 0.00357, 0.00367, 0.00326, 0.00194, 0.00153, 0.00143, 0.00122, 0.00122, 0.00112, 0.0, -0.00102, -0.00204, -0.00255, -0.00296, -0.00337, -0.00377, -0.00489, -0.00642, -0.00785, -0.00938, -0.0109, -0.0124, -0.0141, -0.0146, -0.0122, -0.0105, -0.00795, -0.00683, -0.00642, -0.00591, -0.00571, -0.00540, -0.00510, -0.00489, -0.00459, -0.00428, -0.00398, -0.00316, -0.00265, -0.00112, 0.00102, 0.00316, 0.00469, 0.00489, 0.00551, 0.00561, 0.00642, 0.00857, 0.0103, 0.00857, 0.00724, 0.00540, 0.00337, 0.00286, 0.00296, 0.00286, 0.00275, 0.00122, -0.000102, -0.00102, -0.00112, -0.00163, -0.00153, -0.00316, -0.00693, -0.0101, -0.0104, -0.0107, -0.0108, -0.0101, -0.00908, -0.00806, -0.00755, -0.00734, -0.00693, -0.00683, -0.00642, -0.00408, -0.00133, 0.00133, 0.00438, 0.00724, 0.0101, 0.00877, 0.00642, 0.00418, 0.00133, -0.00143, -0.00357, -0.00377, -0.00449, -0.00469, -0.00500, -0.00520, -0.00551, -0.00571, -0.00591, -0.00469, -0.00296, -0.00133, 0.000714, 0.00173, 0.00194, 0.00255, 0.00255, 0.00357, 0.00510, 0.00653, 0.00816, 0.00959, 0.00989, 0.0104, 0.0107, 0.0110, 0.0112, 0.0106, 0.0101, 0.00948, 0.00877, 0.00806, 0.00734, 0.00642, 0.00561, 0.00469, 0.00387, 0.00316, 0.00275, 0.00214, 0.00173, 0.00122, 0.000714, 0.000306, 0.000816, 0.00133, 0.00194, 0.00224, 0.000918, -0.000306, -0.00173, -0.00316, -0.00479, -0.00540, -0.00489, -0.00438, -0.00387, -0.00255, -0.000918, 0.000714, 0.00173, 0.00224, 0.00357, 0.00622, 0.00846, 0.0114, 0.0109, 0.00887, 0.00724, 0.00479, 0.00275, 0.000408, -0.00163, -0.00245, -0.00337, -0.00469, -0.00704, -0.00857, -0.00897, -0.00948, -0.00969, -0.00989, -0.0101, -0.0103, -0.0104, -0.00999, -0.00969, -0.00918, -0.00887, -0.00908, -0.00928, -0.00948, -0.00979, -0.00989, -0.00897, -0.00826, -0.00724, -0.00693, -0.00693, -0.00683, -0.00683, -0.00673, -0.00673, -0.00653, -0.00571, -0.00510, -0.00438, -0.00347, -0.00235, -0.00133, -0.000204, 0.00102, 0.00173, 0.000918, 0.000306, -0.000510, -0.00143, -0.000714, 0.000612, 0.00163, 0.00133, 0.00122, 0.000816, 0.000510, 0.0, 0.000204, 0.000918, 0.00143, 0.00214, 0.00224, 0.00102, 0.0, -0.00122, -0.00245, -0.00245, -0.00194, -0.00163, -0.00184, -0.00224, -0.00275, -0.00306, -0.00265, -0.00224, -0.00224, -0.00326, -0.00418, -0.00520, -0.00469, -0.00438, -0.00387, -0.00326, -0.00265, -0.00204, -0.00194, -0.00184, -0.00153, 0.00133, 0.00418, 0.00683, 0.00714, 0.00775, 0.00795, 0.00816, 0.00826, 0.00857, 0.00795, 0.00622, 0.00489, 0.00316, 0.00296, 0.00306, 0.00326, 0.00357, 0.00377, 0.00245, 0.000714, -0.000816, -0.00286, -0.00357, -0.00224, -0.00133, 0.000102, 0.000306, 0.000102, -0.000102, -0.000510, -0.000816, -0.00112, -0.00153, -0.00122, -0.000816, -0.000408, 0.000102, 0.000510, 0.000816, 0.000816, 0.000918, 0.00102, 0.00224, 0.00337, 0.00469, 0.00602, 0.00734, 0.00806, 0.00632, 0.00510, 0.00326, 0.00163, -0.000408, 0.0, 0.00306, 0.00530, 0.00887, 0.00836, 0.00316, -0.000204, -0.00632, -0.00286, 0.00591, 0.0133, 0.0225, 0.0189, 0.00959, 0.00928, 0.00785, 0.00918, 0.00163, -0.00857, -0.0204, -0.0151, -0.000714, 0.0109, 0.0101, 0.00489, 0.000306, -0.00704, -0.0109, -0.00153, 0.00704, 0.0141, 0.00683, 0.00204, 0.00357, 0.00918, 0.00877, 0.00530, 0.00245, 0.00163, 0.00133, -0.00112, -0.00347, -0.00683, -0.00551, -0.00204, 0.00143, 0.00489, 0.00989, 0.00591, -0.00489, -0.0121, -0.00969, -0.00612, -0.00245, 0.00326, 0.00387, 0.00143, -0.000102, -0.000714, 0.000612, 0.00102, 0.00245, 0.00133, 0.000408, -0.000816, -0.00275, -0.00561, -0.00857, -0.00948, -0.00622, -0.00367, -0.000204, 0.00337, 0.00377, -0.00143, -0.00459, -0.0105, -0.00785, -0.00235, 0.00316, 0.00418, 0.00265, 0.00133, 0.00153, 0.00622, 0.00744, 0.00755, 0.00775, 0.00744, 0.00724, 0.00581, 0.00387, 0.00214, -0.000204, -0.00337, -0.00653, -0.00693, -0.00520, -0.00551, -0.00551, -0.00581, -0.00337, 0.0, 0.00337, 0.00714, 0.00979, 0.00867, 0.00816, 0.00693, 0.00765, 0.00785, 0.00867, 0.00622, 0.00377, 0.000714, -0.000102, 0.000408, 0.000510, -0.00102, -0.00296, -0.00469, -0.00704, -0.00663, -0.00449, -0.00286, -0.000714, -0.00235, -0.00337, -0.00520, -0.00612, -0.00571, -0.00551, -0.00510, -0.00673, -0.00928, -0.0116, -0.0143, -0.0141, -0.0143, -0.0123, -0.00979, -0.00755, -0.00469, -0.00347, -0.00428, -0.00459, -0.00561, -0.00642, -0.00734, -0.00816, -0.00744, -0.00530, -0.00377, -0.00265, -0.00143
])
DT = 0.02

# ============================================================================
# BUILDING PARAMETERS
# ============================================================================

mass = 202472.0
height = 14.0
stiffness = 47.52e6
zeta = 0.05
Fy = 500000.0
b = 0.02

omega = np.sqrt(stiffness / mass)
period = 2*np.pi / omega
c = 2*zeta*np.sqrt(stiffness*mass)
uy = Fy / stiffness

damage_states = {
    "DS1_Slight":    {"drift": 0.004, "disp": 0.004 * height},
    "DS2_Moderate":  {"drift": 0.008, "disp": 0.008 * height},
    "DS3_Extensive": {"drift": 0.015, "disp": 0.015 * height},
    "DS4_Complete":  {"drift": 0.025, "disp": 0.025 * height}
}

# Newmark reference thetas (for bounded optimization)
newmark_reference_thetas = {
    "DS1_Slight": 0.771,
    "DS2_Moderate": 1.436,
    "DS3_Extensive": 2.149,
    "DS4_Complete": 3.357
}

print(f"\nBuilding: 4-Story RC Frame")
print(f"Material: Steel01 (b={b})")
print(f"Period: {period:.3f}s")

# ============================================================================
# OPENSEES SOLVER
# ============================================================================

def run_opensees_fixed(pga_target):
    """Fixed OpenSees analysis"""
    ops.wipe()
    ops.model('basic', '-ndm', 1, '-ndf', 1)

    ops.node(1, 0.0)
    ops.node(2, 0.0)
    ops.fix(1, 1)
    ops.mass(2, mass)

    scale_factor = pga_target / np.max(np.abs(AG))
    acc = AG * scale_factor * 9.81

    ops.uniaxialMaterial("Steel01", 1, Fy, stiffness, b)
    ops.element("zeroLength", 1, 1, 2, "-mat", 1, "-dir", 1)

    alphaM = 2*zeta*omega
    ops.rayleigh(alphaM, 0, 0, 0)

    ops.timeSeries("Path", 1, "-dt", DT, "-values", *acc.tolist())
    ops.pattern("UniformExcitation", 1, 1, "-accel", 1)

    temp_dir = tempfile.gettempdir()
    temp_file = os.path.join(temp_dir, f"disp_{uuid.uuid4()}.txt")

    ops.recorder("Node", "-file", temp_file, "-node", 2, "-dof", 1, "disp")

    ops.constraints("Plain")
    ops.numberer("RCM")
    ops.system("BandGeneral")
    ops.algorithm("Newton")
    ops.integrator("Newmark", 0.5, 0.25)
    ops.analysis("Transient")

    n_steps = len(acc)
    for i in range(n_steps):
        ok = ops.analyze(1, DT)
        if ok != 0:
            ok = ops.analyze(1, DT/2)

    result = np.nan
    try:
        if os.path.exists(temp_file):
            data = np.loadtxt(temp_file)
            if len(data.shape) == 1:
                result = np.abs(data).max()
            else:
                disp_col = data[:, -1]
                result = np.abs(disp_col).max()
        else:
            result = np.nan
    except Exception as e:
        result = np.nan
    finally:
        if os.path.exists(temp_file):
            os.remove(temp_file)

    return result

# ============================================================================
# TRAINING DATA
# ============================================================================

def generate_training(N=100):
    print(f"\nPhase 1: Generating {N} training samples (OpenSees)...")
    np.random.seed(42)
    pgas = np.sort(np.random.uniform(0.05, 3.0, N))

    data = []
    failed_count = 0

    for i, p in enumerate(pgas):
        u = run_opensees_fixed(p)

        if not np.isnan(u) and u > 0:
            drift = u / height
            data.append({"pga": p, "u_max": u, "drift": drift})
            if (i+1) % 30 == 0:
                print(f"  {i+1}/{N}: PGA={p:.2f}g, u_max={u*1000:.2f}mm, drift={drift*100:.2f}%")
        else:
            failed_count += 1

    if failed_count > 0:
        print(f"  Warning: {failed_count} analyses produced NaN or zero displacement")

    return data

# ============================================================================
# NEURAL NETWORK
# ============================================================================

class Surrogate(nn.Module):
    def __init__(self):
        super().__init__()
        self.net = nn.Sequential(
            nn.Linear(1, 128), nn.ReLU(), nn.Dropout(0.3),
            nn.Linear(128, 128), nn.ReLU(), nn.Dropout(0.3),
            nn.Linear(128, 64), nn.ReLU(), nn.Dropout(0.3),
            nn.Linear(64, 1), nn.Softplus()
        )

    def forward(self, x):
        return self.net(x)

def train_surrogate(data):
    print(f"\nPhase 2: Training surrogate model ({len(data)} samples)...")
    model = Surrogate().to(device)
    optimizer = optim.Adam(model.parameters(), lr=1e-3, weight_decay=1e-4)
    scheduler = optim.lr_scheduler.ReduceLROnPlateau(optimizer, patience=500, factor=0.5)

    X = torch.tensor([[d['pga']] for d in data], dtype=torch.float32, device=device)
    y = torch.tensor([[d['u_max']] for d in data], dtype=torch.float32, device=device)

    X_min, X_max = X.min(), X.max()
    y_min, y_max = y.min(), y.max()
    X_norm = (X - X_min) / (X_max - X_min + 1e-8)
    y_norm = (y - y_min) / (y_max - y_min + 1e-8)

    val_split = 0.2
    n_val = max(1, int(len(data) * val_split))
    indices = torch.randperm(len(data))
    train_idx, val_idx = indices[:-n_val], indices[-n_val:]

    X_train, X_val = X_norm[train_idx], X_norm[val_idx]
    y_train, y_val = y_norm[train_idx], y_norm[val_idx]

    best_val_loss = float('inf')
    patience = 200
    patience_count = 0

    for ep in range(10000):
        model.train()
        optimizer.zero_grad()
        y_pred = model(X_train)
        loss = torch.mean((y_pred - y_train)**2)
        loss.backward()
        optimizer.step()

        model.eval()
        with torch.no_grad():
            y_val_pred = model(X_val)
            val_loss = torch.mean((y_val_pred - y_val)**2)

        scheduler.step(val_loss)

        if val_loss < best_val_loss:
            best_val_loss = val_loss
            patience_count = 0
            best_state = model.state_dict()
        else:
            patience_count += 1
            if patience_count >= patience:
                model.load_state_dict(best_state)
                print(f"  Early stopping at epoch {ep+1}")
                break

        if (ep+1) % 2000 == 0:
            print(f"  Epoch {ep+1}: Train Loss={loss.item():.6e}, Val Loss={val_loss.item():.6e}")

    model.X_min, model.X_max = X_min, X_max
    model.y_min, model.y_max = y_min, y_max
    return model

# ============================================================================
# MONTE CARLO
# ============================================================================

def run_mc(model, pga_levels, n=5000):
    print(f"\nPhase 3: Monte Carlo simulation ({n} samples/PGA)...")
    results = []
    model.eval()

    for p_idx, p in enumerate(pga_levels):
        pga_mc_gm = np.random.normal(p, 0.15*p, n)
        pga_mc_gm = np.clip(pga_mc_gm, p*0.7, p*1.3)

        stiff_factor = np.random.normal(1.0, 0.10, n)
        damp_factor = np.random.normal(1.0, 0.05, n)

        for i in range(n):
            stiff_effect = 1.0 / stiff_factor[i]
            damp_effect = 1.0 / (1 + damp_factor[i])
            pga_adj = pga_mc_gm[i] * stiff_effect * damp_effect

            pga_t = torch.tensor([[pga_adj]], dtype=torch.float32, device=device)
            with torch.no_grad():
                u_norm = model((pga_t - model.X_min) / (model.X_max - model.X_min + 1e-8))
                u_max = u_norm * (model.y_max - model.y_min) + model.y_min

            results.append({"pga": p, "u_max": u_max.item()})

        if (p_idx+1) % 5 == 0:
            print(f"  PGA {p_idx+1}/{len(pga_levels)}: {(p_idx+1)*n} samples")

    return pd.DataFrame(results)

# ============================================================================
# FRAGILITY FITTING WITH BOUNDED MLE
# ============================================================================

def compute_fragility_bounded(df_mc, pga_levels, damage_states):
    print(f"\nPhase 4: Fitting fragility curves (with bounded MLE)...")
    curves = {}

    for ds, ds_info in damage_states.items():
        limit = ds_info['disp']
        probs = []
        for pga in pga_levels:
            dfp = df_mc[df_mc['pga'] == pga]
            p = np.mean(dfp['u_max'] >= limit)
            probs.append(p)

        probs = np.array(probs)

        def nll(params):
            theta, beta = params
            if theta <= 0 or beta <= 0:
                return 1e10
            P = norm.cdf((np.log(pga_levels) - np.log(theta)) / beta)
            P = np.clip(P, 1e-10, 1-1e-10)
            n_per_pga = len(df_mc) / len(pga_levels)
            n_exceed = np.round(probs * n_per_pga).astype(int)
            nll_val = 0
            for j, (n_f, n_tot) in enumerate(zip(n_exceed, np.full(len(pga_levels), int(n_per_pga)))):
                nll_val -= n_f * np.log(P[j]) + (n_tot - n_f) * np.log(1 - P[j])
            return nll_val

        # Set bounds based on Newmark reference
        ref_theta = newmark_reference_thetas[ds]
        theta_min = ref_theta * 0.8
        theta_max = ref_theta * 1.5

        best_result = None
        best_nll = float('inf')

        for start in range(5):
            idx_50 = np.argmin(np.abs(probs - 0.5))
            theta_init = pga_levels[idx_50] * (0.8 + 0.4 * np.random.rand())
            theta_init = np.clip(theta_init, theta_min, theta_max)

            res = minimize(nll, [theta_init, 0.4],
                          bounds=[(theta_min, theta_max), (0.1, 1.5)],
                          method='L-BFGS-B')
            if res.fun < best_nll:
                best_nll = res.fun
                best_result = res

        theta, beta = best_result.x
        im = np.linspace(0.01, max(pga_levels)*1.5, 2000)
        P = norm.cdf((np.log(im) - np.log(theta)) / beta)

        curves[ds] = {
            'theta': theta,
            'beta': beta,
            'IM': im,
            'P': P,
            'pga_data': pga_levels,
            'probs': probs
        }

    return curves

# ============================================================================
# PLOTTING (CLEAN - NO MARKERS)
# ============================================================================

def plot_fragility_clean(curves):
    print(f"\nPhase 5: Creating clean plot (no markers)...")

    plt.figure(figsize=(14, 9))
    plt.title("Fragility Curves (OpenSees)", fontsize=18, fontweight='bold')
    plt.xlabel("PGA (g)", fontsize=14, fontweight='bold')
    plt.ylabel("Probability of Exceedance", fontsize=14, fontweight='bold')
    plt.grid(True, alpha=0.3)

    colors = {
        "DS1_Slight": "blue",
        "DS2_Moderate": "gold",
        "DS3_Extensive": "red",
        "DS4_Complete": "darkred"
    }

    for ds, curve in curves.items():
        color = colors[ds]

        # CLEAN: Pure line only (NO markers, NO scatter points)
        plt.plot(curve["IM"], curve["P"], color=color, linewidth=3.5,
                label=f"{ds.split('_')[1]} (θ={curve['theta']:.3f}g, β={curve['beta']:.3f})",
                zorder=3)

    plt.legend(fontsize=12, loc='lower right', framealpha=0.95)
    plt.ylim([0, 1.05])
    plt.tight_layout()
    plt.savefig('fragility_opensees_clean.png', dpi=300, bbox_inches='tight')
    print("✓ Plot saved: fragility_opensees_clean.png (clean, no markers)")
    plt.show()

# ============================================================================
# PERFORMANCE MATRIX
# ============================================================================

def print_performance_matrix(training_data, curves, df_mc, pga_levels):
    print("\n" + "="*100)
    print("COMPLETE PERFORMANCE MATRIX - OPENSEES (STEEL01 - FIXED) ANALYSIS")
    print("="*100)

    print("\n1. BUILDING PROPERTIES")
    print("-"*100)
    props = [
        ['Mass', f'{mass:.0f} kg'],
        ['Height', f'{height:.1f} m'],
        ['Lateral Stiffness', f'{stiffness/1e6:.2f} MN/m'],
        ['Natural Period', f'{period:.3f} s'],
        ['Damping Ratio', f'{zeta*100:.1f}%'],
        ['Yield Force', f'{Fy/1000:.1f} kN'],
        ['Yield Displacement', f'{uy*1000:.2f} mm'],
        ['Material', 'Steel01 (kinematic hardening)'],
        ['Hardening Ratio', f'b={b}']
    ]
    for p in props:
        print(f"{p[0]:30s} {p[1]}")

    print("\n2. DAMAGE STATES (IS 1893:2016)")
    print("-"*100)
    print(f"{'Damage State':20s} {'Drift (%)':15s} {'Displacement (mm)':15s}")
    for name, info in damage_states.items():
        print(f"{name:20s} {info['drift']*100:15.2f} {info['disp']*1000:15.0f}")

    print("\n3. TRAINING DATA STATISTICS")
    print("-"*100)
    u_vals = [d['u_max'] for d in training_data]
    drift_vals = [d['drift'] for d in training_data]
    props = [
        ['Number of Samples', f"{len(training_data)}"],
        ['PGA Min', f"{min([d['pga'] for d in training_data]):.3f}g"],
        ['PGA Max', f"{max([d['pga'] for d in training_data]):.3f}g"],
        ['u_max Min', f"{min(u_vals)*1000:.1f} mm"],
        ['u_max Max', f"{max(u_vals)*1000:.1f} mm"],
        ['Avg Drift', f"{np.mean(drift_vals)*100:.2f}%"]
    ]
    for p in props:
        print(f"{p[0]:30s} {p[1]}")

    print("\n4. MONTE CARLO STATISTICS")
    print("-"*100)
    props = [
        ['Total Samples', f"{len(df_mc)}"],
        ['Samples per PGA', f"{len(df_mc) // len(pga_levels)}"],
        ['PGA Levels', f"{len(pga_levels)}"],
        ['Uncertainty Sources', "3 (PGA + Material + Damping)"],
        ['Mean u_max', f"{df_mc['u_max'].mean()*1000:.1f} mm"],
        ['Std u_max', f"{df_mc['u_max'].std()*1000:.1f} mm"]
    ]
    for p in props:
        print(f"{p[0]:30s} {p[1]}")

    print("\n5. FRAGILITY CURVE PARAMETERS (WITH BOUNDED MLE - FIXED)")
    print("-"*100)
    print(f"{'Damage State':20s} {'θ (g)':12s} {'β':12s} {'Threshold (mm)':15s}")
    for ds, frag in curves.items():
        threshold = damage_states[ds]['disp']
        print(f"{ds:20s} {frag['theta']:12.3f} {frag['beta']:12.3f} {threshold*1000:15.0f}")

    print("\n6. INTENSITY-DAMAGE ANALYSIS (IDA)")
    print("-"*100)
    print(f"{'PGA (g)':10s} {'Mean u_max (mm)':18s} {'Std (mm)':12s} {'Min (mm)':12s} {'Max (mm)':12s}")
    for pga in pga_levels:
        df_p = df_mc[df_mc['pga'] == pga]
        print(f"{pga:10.2f} {df_p['u_max'].mean()*1000:18.1f} {df_p['u_max'].std()*1000:12.1f} {df_p['u_max'].min()*1000:12.1f} {df_p['u_max'].max()*1000:12.1f}")

    print("\n" + "="*100)

# ============================================================================
# MAIN
# ============================================================================

def main():
    training_data = generate_training(N=100)

    if len(training_data) < 10:
        print("ERROR: Not enough valid training data from OpenSees!")
        return

    model = train_surrogate(training_data)

    pga_levels = np.array([0.05, 0.1, 0.15, 0.2, 0.3, 0.4, 0.5, 0.6, 0.8, 1.0, 1.2, 1.5, 2.0, 2.5, 3.0])
    df_mc = run_mc(model, pga_levels, n=5000)

    curves = compute_fragility_bounded(df_mc, pga_levels, damage_states)

    plot_fragility_clean(curves)
    print_performance_matrix(training_data, curves, df_mc, pga_levels)

    print("\n" + "="*100)
    print("✓✓✓ ANALYSIS COMPLETE ✓✓✓")
    print("="*100 + "\n")

if __name__ == "__main__":
    main()

Result:

OPENSEES FRAGILITY ANALYSIS - 


Building: 4-Story RC Frame
Material: Steel01 (b=0.02)
Period: 0.410s

Phase 1: Generating 100 training samples (OpenSees)...
  30/100: PGA=0.81g, u_max=86.16mm, drift=0.62%
  60/100: PGA=1.71g, u_max=251.15mm, drift=1.79%
  90/100: PGA=2.67g, u_max=451.45mm, drift=3.22%

Phase 2: Training surrogate model (100 samples)...
  Early stopping at epoch 1333

Phase 3: Monte Carlo simulation (5000 samples/PGA)...
  PGA 5/15: 25000 samples
  PGA 10/15: 50000 samples
  PGA 15/15: 75000 samples

Phase 4: Fitting fragility curves (with bounded MLE)...

Phase 5: Creating clean plot (no markers)...
✓ Plot saved: fragility_opensees_clean.png (clean, no markers)


====================================================================================================
COMPLETE PERFORMANCE MATRIX - OPENSEES (STEEL01 - FIXED) ANALYSIS
====================================================================================================

1. BUILDING PROPERTIES
----------------------------------------------------------------------------------------------------
Mass                           202472 kg
Height                         14.0 m
Lateral Stiffness              47.52 MN/m
Natural Period                 0.410 s
Damping Ratio                  5.0%
Yield Force                    500.0 kN
Yield Displacement             10.52 mm
Material                       Steel01 (kinematic hardening)
Hardening Ratio                b=0.02

2. DAMAGE STATES (IS 1893:2016)
----------------------------------------------------------------------------------------------------
Damage State         Drift (%)       Displacement (mm)
DS1_Slight                      0.40              56
DS2_Moderate                    0.80             112
DS3_Extensive                   1.50             210
DS4_Complete                    2.50             350

3. TRAINING DATA STATISTICS
----------------------------------------------------------------------------------------------------
Number of Samples              100
PGA Min                        0.066g
PGA Max                        2.961g
u_max Min                      4.7 mm
u_max Max                      519.0 mm
Avg Drift                      1.55%

4. MONTE CARLO STATISTICS
----------------------------------------------------------------------------------------------------
Total Samples                  75000
Samples per PGA                5000
PGA Levels                     15
Uncertainty Sources            3 (PGA + Material + Damping)
Mean u_max                     63.2 mm
Std u_max                      69.6 mm

5. FRAGILITY CURVE PARAMETERS (WITH BOUNDED MLE - FIXED)
----------------------------------------------------------------------------------------------------
Damage State         θ (g)        β            Threshold (mm) 
DS1_Slight                  1.157        0.198              56
DS2_Moderate                1.862        0.178             112
DS3_Extensive               2.714        0.179             210
DS4_Complete                4.588        0.192             350

6. INTENSITY-DAMAGE ANALYSIS (IDA)
----------------------------------------------------------------------------------------------------
PGA (g)    Mean u_max (mm)    Std (mm)     Min (mm)     Max (mm)    
      0.05               17.4          0.1         17.0         18.0
      0.10               18.1          0.3         17.5         19.4
      0.15               18.9          0.4         17.8         20.6
      0.20               19.7          0.6         18.2         22.8
      0.30               21.6          1.1         19.2         26.7
      0.40               23.7          1.6         20.1         32.3
      0.50               26.1          2.3         20.8         37.7
      0.60               28.9          3.2         22.0         46.9
      0.80               35.3          5.3         24.4         66.5
      1.00               44.1          8.9         27.3         97.4
      1.20               55.1         13.8         30.4        175.0
      1.50               79.3         27.2         36.0        217.7
      2.00              136.6         43.8         46.4        289.9
      2.50              190.3         43.2         62.6        376.0
      3.00              233.4         45.4         84.8        487.6

====================================================================================================

====================================================================================================
✓✓✓ ANALYSIS COMPLETE ✓✓✓
====================================================================================================
